service: poff-api

provider:
    name: aws
    runtime: nodejs12.x
    stage: prod
    stackName: ${self:provider.stage}-${self:service}
    apiName: ${self:provider.stage}-${self:service}
    region: eu-central-1
    endpointType: regional
    memorySize: 256
    timeout: 21
    logRetentionInDays: 365
    httpApi:
        cors: true
        payload: '2.0'
    logs:
        httpApi: true
    # tracing:
    #     lambda: true

    deploymentBucket:
        name: ${self:service}
        serverSideEncryption: AES256

    environment:
        GIT_BRANCH: ${git:branch}
        GIT_SHA1: ${git:sha1}

layers:
    commonNodeLibs:
        path: layers
        compatibleRuntimes:
            - nodejs12.x

package:
    individually: true
    exclude:
        - layers/**
        - node_modules/**
        - src/**
        - '*'

plugins:
    - serverless-plugin-git-variables

custom:
    exportGitVariables: false

functions:
    auth-post:
        handler: src/auth/post.handler
        name: ${self:provider.stage}-${self:service}-auth-post
        description: Authenticates user by username and password
        package:
            include:
                - src/auth/post.js
        layers:
            - {Ref: CommonNodeLibsLambdaLayer}
        events:
            -
                httpApi: POST /auth

    auth-eventival-get:
        handler: src/auth/eventival/get.handler
        name: ${self:provider.stage}-${self:service}-auth-eventival-get
        description: Redirects user to auth in Eventival
        package:
            include:
                - src/auth/eventival/get.js
        layers:
            - {Ref: CommonNodeLibsLambdaLayer}
        events:
            -
                httpApi: GET /auth/eventival

    auth-eventival-post:
        handler: src/auth/eventival/post.handler
        name: ${self:provider.stage}-${self:service}-auth-eventival-post
        description: Handles return request from Eventival auth
        package:
            include:
                - src/auth/eventival/post.js
        layers:
            - {Ref: CommonNodeLibsLambdaLayer}
        events:
            -
                httpApi: POST /auth/eventival

    auth-facebook-get:
        handler: src/auth/facebook/get.handler
        name: ${self:provider.stage}-${self:service}-auth-facebook-get
        description: Redirects user to auth in facebook
        package:
            include:
                - src/auth/facebook/get.js
        layers:
            - {Ref: CommonNodeLibsLambdaLayer}
        events:
            -
                httpApi: GET /auth/facebook

    auth-facebook-post:
        handler: src/auth/facebook/post.handler
        name: ${self:provider.stage}-${self:service}-auth-facebook-post
        description: Handles return request from facebook auth
        package:
            include:
                - src/auth/facebook/post.js
        layers:
            - {Ref: CommonNodeLibsLambdaLayer}
        events:
            -
                httpApi: POST /auth/facebook

    auth-google-get:
        handler: src/auth/google/get.handler
        name: ${self:provider.stage}-${self:service}-auth-google-get
        description: Redirects user to auth in Google
        package:
            include:
                - src/auth/google/get.js
        layers:
            - {Ref: CommonNodeLibsLambdaLayer}
        events:
            -
                httpApi: GET /auth/google

    auth-google-post:
        handler: src/auth/google/post.handler
        name: ${self:provider.stage}-${self:service}-auth-google-post
        description: Handles return request from Google auth
        package:
            include:
                - src/auth/google/post.js
        layers:
            - {Ref: CommonNodeLibsLambdaLayer}
        events:
            -
                httpApi: POST /auth/google

    auth-microsoft-get:
        handler: src/auth/microsoft/get.handler
        name: ${self:provider.stage}-${self:service}-auth-microsoft-get
        description: Redirects user to auth in Microsoft
        package:
            include:
                - src/auth/microsoft/get.js
        layers:
            - {Ref: CommonNodeLibsLambdaLayer}
        events:
            -
                httpApi: GET /auth/microsoft

    auth-microsoft-post:
        handler: src/auth/microsoft/post.handler
        name: ${self:provider.stage}-${self:service}-auth-microsoft-post
        description: Handles return request from Microsoft auth
        package:
            include:
                - src/auth/microsoft/post.js
        layers:
            - {Ref: CommonNodeLibsLambdaLayer}
        events:
            -
                httpApi: POST /auth/microsoft

    favourite-get:
        handler: src/favourite/get.handler
        name: ${self:provider.stage}-${self:service}-favourite-get
        description: Returns current user's favourite movies
        package:
            include:
                - src/favourite/get.js
        layers:
            - {Ref: CommonNodeLibsLambdaLayer}
        events:
            -
                httpApi: GET /favourite

    favourite-put:
        handler: src/favourite/put.handler
        name: ${self:provider.stage}-${self:service}-favourite-put
        description: Add movie to current user's favourites
        package:
            include:
                - src/favourite/put.js
        layers:
            - {Ref: CommonNodeLibsLambdaLayer}
        events:
            -
                httpApi: PUT /favourite/{movieId}

    favourite-delete:
        handler: src/favourite/delete.handler
        name: ${self:provider.stage}-${self:service}-favourite-delete
        description: Delete movie from current user's favourites
        package:
            include:
                - src/favourite/delete.js
        layers:
            - {Ref: CommonNodeLibsLambdaLayer}
        events:
            -
                httpApi: DELETE /favourite/{movieId}

    profile-get:
        handler: src/profile/get.handler
        name: ${self:provider.stage}-${self:service}-profile-get
        description: Returns current user's profile
        package:
            include:
                - src/profile/get.js
        layers:
            - {Ref: CommonNodeLibsLambdaLayer}
        events:
            -
                httpApi: GET /profile

    profile-put:
        handler: src/profile/put.handler
        name: ${self:provider.stage}-${self:service}-profile-put
        description: Update current user's profile
        package:
            include:
                - src/profile/put.js
        layers:
            - {Ref: CommonNodeLibsLambdaLayer}
        events:
            -
                httpApi: PUT /profile

    version:
        handler: src/version/get.handler
        name: ${self:provider.stage}-${self:service}-version
        description: Returns current code branch name and commit
        package:
            include:
                - src/version/get.js
        layers:
            - {Ref: CommonNodeLibsLambdaLayer}
        events:
            -
                httpApi: GET /
            -
                httpApi: GET /version

    verif:
        handler: src/verif.handler
        name: ${self:provider.stage}-${self:service}-verif
        description:
        package:
            include:
                - src/verif.js
        layers:
            - {Ref: CommonNodeLibsLambdaLayer}
        events:
            -
                httpApi: GET /verif

    tkns:
        handler: src/tkns.handler
        name: ${self:provider.stage}-${self:service}-tkns
        description:
        package:
            include:
                - src/tkns.js
        layers:
            - {Ref: CommonNodeLibsLambdaLayer}
        events:
            -
                httpApi: GET /tkns

    markQnrAsUnfilled:
        handler: src/markQnrAsUnfilled.handler
        name: ${self:provider.stage}-${self:service}-markQnrAsUnfilled
        description:
        package:
            include:
                - src/markQnrAsUnfilled.js
        layers:
            - {Ref: CommonNodeLibsLambdaLayer}
        events:
            -
                httpApi: GET /markQnrAsUnfilled
